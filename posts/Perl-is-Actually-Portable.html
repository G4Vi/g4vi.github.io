<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=1024">
<title>Perl is Actually Portable | Computoid</title>
<style>
/* Styling heavily inspired from https://justine.lol */
html {
  font-family: sans-serif;
  font-size: 14pt;
}

body {
  max-width: 960px;
  min-width: 960px;
  margin: 0 auto 0 auto;
  margin-top: 2em;
  background: white;
}

h1 {
  margin: 0;
  padding-top: .5em;
  padding-bottom: .5em;
}

.content {
  padding-left: 1.5em;
  padding-right: 1.5em;
}

footer {
  padding-bottom: 1em;
}

li {
  padding: .2em 0;
}

/* new code*/
.ncode {
  color: green;
}

/* deleted code */
.dcode {
  color: red;
}

.nowrap {
  white-space: nowrap;
}

header {
  display: block;
}

header a {
  color: black;
}

#sitename {
  display: inline;
}

/* https://css-tricks.com/a-perfect-table-of-contents-with-html-css/ */
.toc-list, .toc-list ol {
  list-style-type: none;
}

.toc-list {
  padding: 0;
}

.toc-list ol {
  padding-inline-start: 2ch;
}

</style>
</head>
<body>
<div class="content">
<header><h2 id="sitename"><a href="../">Computoid</a></h2> | <a href="../about/">About</a> | <a href="../APPerl/">APPerl</a></header>
<h1 id="TITLE" style="padding-bottom: 0">Perl is Actually Portable</h1>
<small><time>October XX, 2022</time> by Gavin Hayes</small>
<p>Upon stumbling upon Gautham's <a href="https://ahgamut.github.io/2021/07/13/ape-python/">APE Python port</a> and seeing how far along the Cosmopolitan Libc has come along I became inspired to see what it would take to port my scripting language of choice, Perl to the Cosmopolitan Libc and turn it into a self-contained binary. Part of this interest came from wanting prove that Perl can do it too and part came from wanting a more robust Windows Perl port for running my personal media server (MHFS) after running into issues attempting to port it to Strawberry Perl.</p>
<h3 style="padding-bottom: 0; margin: 0;">Table of Contents</h3>
<ol class="toc-list" role="list" style="margin-top: 0;">
  <li><a href="#Building Perl with the Cosmopolitan Libc">1.0 Building Perl with the Cosmopolitan Libc</a>
    <ol role="list">
      <li><a href="#Passing make minitest">1.1 Passing <code>make minitest</code></a></li>
      <li><a href="#Building Full Perl">1.2 Building Full Perl</a></li>
    </ol>
  </li>
  <li><a href="#Building Actually Portable Perl (APPerl)">2.0 Building Actually Portable Perl (APPerl)</a>
    <ol role="list">
      <li><a href="#Getting perldoc working on Windows">2.1 Getting perldoc working on Windows</a></li>
      <li><a href="#argv[0] script execution">2.2 argv[0] script execution</a></li>
    </ol>
  </li>
  <li><a href="#The APPerl Perl distribution">3.0 The APPerl Perl distribution</a>
    <ol>
      <li><a href="#Dogfooding">3.1 Dogfooding</a></li>
    </ol>
  </li>
  <li><a href="#Wrap Up">4.0 Wrap Up</a></li>
</ol>
<h2 id="Building Perl with the Cosmopolitan Libc">Building Perl with the Cosmopolitan Libc</h2>
<p>After cloning the Perl source, the first step was generating a proper build config with <code>Configure</code>. <code>Configure</code> is not generated by GNU Autotools, but by Perl's own configuration generator generator, <code>metaconfig</code>, originally written by Larry Wall himself. Following Gautham's original port I made a <code>superConfigure</code>script to invoke <code>Configure</code> with the flags needed to build with cosmopolitan. Unfortunately, just because flags were passed in, didn't mean <code>Configure</code> had to use them. In particular, <code>libs</code> set would be applied to the build config, but weren't used in most places for <code>Configure</code>'s own testing. Building for the Cosmopolitan Libc requires passing a large incantation of flags to <code>gcc</code> as it isn't bound to the C compiler. Edits aren't supposed to be made directly to <code>Configure</code>, but patches could be generated later or <code>metaconfig</code> could be modified to accommodate cosmopolitan later. Modifying <code>Configure</code> to always pass <code>libs</code> wasn't difficult, it just had to be done in a few places:<br><span><code>$cc -o try $ccflags $ldflags try.c <span class="ncode">$libs</span></code></span></p>

<p>Unsurprisingly after the first <code>Configure</code>, the build failed. This appeared to be due to missing headers. Initially this was fixed in two ways, preventing <code>Configure</code> from finding non-cosmopolitan headers and adding dummy (empty) header files to it and <code>gcc</code>'s search path. At this point, <code>cosmopolitan.h</code> from the amalgamation was setup to always be included, however <code>Configure</code> and the Perl build depends on the libc headers being available. This strategy seemed like an easy fix, but later was determined to be problematic. <code>Configure</code> checked for availability of certain libc symbols by declaring them and seeing if it compiled. This needed to be patched to not declare the symbol, just use it as <code>cosmopolitan.h</code> always included all the symbols.<br>
<code class="dcode">$extern_C void *$1$tdc; void *(*(p()))$tdc { return &$1; }</code><br>
<code class="ncode">void *(*(p()))$tdc { return (void*)&$1; }</code><br>
</p>
<p>
Inside Perl itself, it was also discovered that it sometimes tries to declare symbols itself leading to conflicting types errors. Temporarily it was fine to comment out the declaration as <code>cosmopolitan.h</code> had it's own declaration.</p>
<pre><code><span class="ncode">//</span>Uid_t getuid (void);
<span class="ncode">//</span>Uid_t geteuid (void);
<span class="ncode">//</span>Gid_t getgid (void);
<span class="ncode">//</span>Gid_t getegid (void);</code></pre>

<p>After the last change, miniperl built! Perl programmers often prefer to write Perl to <i>sh</i> so Perl is built with Perl! In order to not have a chicken-and-egg situation making it difficult to port Perl to new platforms, the first thing built is <code>miniperl</code>, Perl without C or XS extension modules that can be used to assist with building the rest of Perl.</p>

<p>To reduce dependence on the <code>superConfigure</code> script and make building for cosmopolitan less different from building for other platforms in Perl, at this point a <code>hints</code> file was created, <code>hints/cosmo.sh</code>. Once platform is detected or set in <code>Configure</code>, it loads in the corresponding settings to ease building Perl for a platform.</p>

<h3 id="Passing make minitest">Passing <code>make minitest</code></h3>

<p>miniperl appeared to work the basics, but <code>make</code> had failed and it suggested running <code>make minitest</code> a subset of tests that can be ran on <code>miniperl</code>. For a first run <code>make minitest</code> wasn't too bad: <b><code>Failed 95 tests out of 339, 71.98% okay.</code></b> However, it was alarming that a crash in miniperl that kept popping up</p>

<code>
libc/zipos/find.c:34: assert(ZIP_CFILE_MAGIC(zipos->map + c) == kZipCfileHdrMagic) failed
</code>

<p>Fortunately, it was an easy fix; the <code>Makefile</code> in addition to building ELF executables like usual, needed to use <code>objcopy</code> to create APEs or Actually Portable Executables. <code>zipos</code>, cosmopolitan's internal ZIP filesystem fails to load on non-APE binaries. <code class="ncode nowrap">objcopy -S -O binary _miniperl miniperl.com</code>. <code>make minitest</code> ran a lot better after switching to the APE and a couple more <code>Configure</code> tweaks: <b><code>Failed 13 tests out of 357, 96.36% okay.</code></b></p>

<p>Removing the stack protector from the Perl build resolved the additional crashes. <code>gcc</code>'s stack protector isn't compatible with the the Cosmopolitan Libc. Adding <code>-fno-stack-protector</code> to the <code>ccflags</code> stopped <code>Configure</code> from enabling it.
<b><code>Failed 12 tests out of 359, 96.66% okay.</code></b></p>

<p>Failure to load the <code>Errno</code> module caused several of the <code>minitest</code> failures. The <code>Errno</code> module is a pure perl module, however it is generated from the result of parsing C headers and output from the C preprocessor. Due to cosmopolitan wanting to be as thin of a wrapper as possible, the "constants" depend on the currently running operating system and thus must be determined at runtime. The constants for the unix-like platforms are in <a href="https://github.com/jart/cosmopolitan/blob/master/libc/sysv/consts.sh"><code>consts.sh</code></a>. Therefore, the "constants" couldn't be simply hard-coded to integer values in <code>Errno.pm</code>. The solution was to make a C extension (<a href="https://github.com/G4Vi/perl5/blob/cosmo-perl-v5.37-plus-dontuse/ext/ErrnoRuntime/ErrnoRuntime.xs"><code>ErrnoRuntime</code>)</a> <code>Errno</code> can use to load the current values, however, that didn't solve the problem of <code>Errno</code> not working for miniperl because miniperl doesn't include the C extensions as it is used to build the extensions. To work around this in order to test the rest of the modules and build the rest of Perl, I setup <code>Errno.pm</code> to have the current (build-time) constants for use under miniperl only.</p>

<p>In the midst of the <code>Errno</code> patches, I switched away from using the amalgamation header, <code>cosmopolitan.h</code> to use cosmo's <code>libc/isystem</code> directory as that removed the need for dummy headers and stopped everything from being included all the time, fixing some incompatible declarations errors.</p>

<p>Improving and adding to the Cosmopolitan Libc fixed the remaining <code>make minitest</code> failures. Perl's massive test suite did a pretty good job of alerting me to issues before encountering them in normal use. Working on something as base as a libc is exciting as you get to see how the sausage gets made and the opportunity to make some high-impact contributions to open source as your code may be used in thousands of programs.</p>

<ul>
<li><a href="https://github.com/jart/cosmopolitan/pull/532">utimesat: stop zipos case from interfering with futimens operation</a></li>
<li><a href="https://github.com/jart/cosmopolitan/pull/539">Stop sys_lseek from truncating return value to 32 bits</a></li>
<li><a href="https://github.com/jart/cosmopolitan/pull/542">Add reallocating environ if it's set NULL / Fix NULL pointer dereference when PutEnvImpl is called after clearenv</a></li>
<li><a href="https://github.com/jart/cosmopolitan/pull/544">Fix stdio fmt of "%.0e" and "%.0g"</a></li>
<li><a href="https://github.com/jart/cosmopolitan/pull/546">setlocale: Add fake support for locale=""</a></li>
</ul>

<p>A variety of headers in <code>libc/isystem</code> were also improved to include the required cosmopolitan headers to match perl and linux's expectations for the headers.</p>

<h3 id="Building Full Perl">Building Full Perl</h3>

<p>After <code>make minitest</code> passed, Perl could be linked together, but without several core standard extensions. As seen with the issues with <code>Errno</code>, cosmopolitan's "constants" did not work in all the places the constants were used due to the "constants" not being compile-time integer values.</p>

<p>Several extensions relied on <code>ExtUtils::Constant</code> to generate the glue code necessary to retrieve the constants to make them available to Perl. <code>ExtUtils::Constant</code> generated <code>static const</code> arrays with the constants in them. To instead generate code compatible with cosmopolitan's "constants", <code>const</code> was dropped from array type and the "constants" were removed from the array: removed items in red:</p>

<pre><code>static <span class="dcode">const</span> struct iv_s values_for_iv[] =
      {
#ifdef AF_INET
        { "AF_INET", 7<span class="dcode">, AF_INET</span> },
#endif
#ifdef AF_INET6
        { "AF_INET6", 8<span class="dcode">, AF_INET6</span> }
#endif
      };</code></pre>
 
<p>Additional code was generated to fill-in the array at runtime:</p>

<pre><code class="ncode">#ifdef AF_INET
values_for_iv[i++].value = AF_INET;
#endif
#ifdef AF_INET6
values_for_iv[i++].value = AF_INET6;
#endif</code></pre>

<p>The newly generated code is fragile as the constant setup is now split between multiple places and the constant assignment code depends on the order being the same as in the array, but given that the generated code is never meant to be edited by humans, so it should be good enough for now.</p>

<p><code>Fnctl</code> and <code>IO</code> were fixed by the <code>ExtUtils::Constant</code> changes.</p>

<p><code>POSIX</code> in addition to the <code>ExtUtils::Constant</code> changes required temporarily disabling some cosmopolitan unimplemented functions and casting a function to the right signature. Later, the incompatibility was fixed in cosmopolitan and these hacks could be removed.</p>

<p><code>Socket</code> in addition to the <code>ExtUtils::Constant</code> changes required declaring a large enough for all platforms, fixed size output buffer instead of one based on a "constant" in <code>inet_ntop</code>. <code>switch</code> statements that included <code>case</code>s with the "constants" had to be switched to <code>if</code> statements.</p>

<p>Now, all the extensions built and the same process for <code>make minitest</code>: test, fix, retest, was done for <code>make test</code> . Adding to and improving Cosmopolitan fixed many of the test failures. Much of this was random <i>POSIX</i> functionality such as:</p>

<ul>
  <li><a href="https://github.com/jart/cosmopolitan/pull/583/files/1aaf7ca99eeb75dd57d470264b145b82ad588ee8"><code>inet_pton</code> IPv6 address parsing</a></li>
  <li><a href="https://github.com/jart/cosmopolitan/pull/597/commits/d009eea0d256167badd3c6610b466a901821a1a4"><code>sigpending</code>, across the various syscall interfaces and Windows polyfill</a></li>
  <li><a href="https://github.com/jart/cosmopolitan/commit/4c40c500b82be387a33ad5c65f084198211507f5"><code>getgroups</code> and <code>setgroups</code></a></li>
</ul>

<h2 id="Building Actually Portable Perl (APPerl)">Building Actually Portable Perl (APPerl)</h2>

<p>With a fairly functional Perl, it could now be turned into APPerl. Perl's cross-compiling facilities and cosmopolitan's ZIP filesystem made getting the base of it not too tricky.</p>

<p>For many purposes, files stored into it's internal zip file can be accessed just like normal files via <code>/zip</code>, a magic path that mapped to the internal zip file. Much of the libc has special handling for it, though it's read-only and cannot be directly <code>exec</code>ed from.</p>

<p>Similar to <code>prefix</code> with <code>autoconf</code>, <code>Configure</code>'s <code>prefix</code> sets the install directory. Setting <code>prefix</code> to <code>/zip</code> should setup Perl to read modules from the zip filesystem. Needing to first install to <code>/zip</code> however, would be inconvenient. Fortunately, setting the <code>DESTDIR</code> variable when running <code>make install</code> allowed installing to files to <code>DESTDIR/prefix</code>, but with Perl still configured for prefix.</p>

<p>After the <code>make install</code>, APPerl was able to be made just by adding the contents of <code>DESTDIR/zip</code> to the APE Perl binary as it is also a zip file.
<code>zip -r "perl.com" "lib" "bin"</code>. The contents <code>bin</code> other than the perl binary that had to be removed isn't actually executables, but perl scripts. For example, <code>perldoc</code> embedded in the binary can be launched with <code>./perl.com /zip/bin/perldoc</code></p>

<h3 id="Getting perldoc working on Windows">Getting <code>perldoc</code> working on Windows</h3>

<p>One of Perl's strengths is it has a large amount of high-quality official and unofficial documentation available. To not starve APPerl users of it, it is critical at works right at their terminal like usual.</p>

<p>Looking at <code>Perldoc.pm</code> it was discovered that <code>perldoc</code> works by generating a pod(Plain Old Documentation) document, writing it to disk, and using shell-invoking <code>system</code> to launch a pager and open the document.</p>

<p>Fortunately, one of the pagers <code>perldoc</code> attempts to use, <code>more</code> actually exists in <code>cmd.exe</code>, so an alternative viewing method was not needed. However, shell-invoking <code>system</code> was broken on Windows as Unix builds of Perl use <code>sh</code> for shell-invoking <code>system</code> usage. Switching to using <code>cmd.exe</code> when running on Windows initially wasn't trivial as cosmopolitan had incorrect <code>argv</code> to command line conversion implemented, but once Justine Tunney fixed that, it wasn't tricky to implement, as cosmopolitan even has some automatic translation between unix file paths to Windows filepaths in the <code>argv</code> to command line translation.</p>

<h3 id="argv[0] script execution"><code>argv[0]</code> script execution</h3>

<p>Most programs ignore <code>argv[0]</code> as their program name isn't relevant to execution. However, it can be used to dispatch just like any of the other arguments. Trying to come up with an easier way to launch <code>perldoc</code>, I remembered a technique used by <a href="https://busybox.net/FAQ.html#source_applets">BusyBox</a> and <a href="https://metacpan.org/pod/pp#DESCRIPTION"><code>PAR::Packer</code></a>, use <code>argv[0]</code> to determine what program to run. APPerl tests the basename of <code>argv[0]</code>(with extension stripped) against the scripts in <code>/zip/bin</code>. If it exists, it runs said script. This allows accessing <code>perldoc</code> with a symlink: <code>ln -s perl.com perldoc</code> and can be used for anything such as making single binary perl applications. <a href="https://github.com/G4Vi/perl5/commit/9719db2dfbb19454177a31d8ce874a61f17a30da#diff-f4fcf861484a0d159aeef20b3d0c409a33f3bbad83b1447eae6e4d514878caae">Patch to <code>perl.c</code></a> to enable <code>argv[0]</code> script execution.</p>

<h2 id="The APPerl Perl distribution">The APPerl Perl distribution</h2>

<p>Rather than releasing a lone binary as a demo and calling it done, it seemed apt to turn APPerl into a Perl distribution. By Perl distribution, I am referring to a binary distribution of Perl such as Strawberry Perl, ActiveState Perl, or how Perl is released on Linux package managers, for example the Debian Perl packages.</p>

<p>With some work, the <code>cosmo</code> platform may be able to get merged into the official Perl source, but the modifications and additions needed to turn Perl into APPerl are ill-suited for the <code>perl5</code> source. Following the model of Strawberry Perl, I created a package for building APPerl, <code>Perl::Dist::APPerl</code>.</p>

<p><code>Perl::Dist::APPerl</code> is made up of <code>apperlm</code> (APPerl Manager) and accompanying documentation. <code>apperlm</code> is used for building APPerl and includes creating and switching build configs.</p>

<p>The full build of APPerl (all standard modules, extensions, and docs) came out to under 24 MiB. To provide a lighter-weight version, the <code>small</code> config was developed and came out to under 5 MiB. Debian's list of files in <code>perl-base</code> was helpful for understanding what would be a decent subset for the <code>small</code> config. Unfortunately, during the process of creating APPerl, Cosmopolitan Libc dropped support for Windows Vista and 7 as it was too difficult to support them as they do not have a true 64 bit address space. <code>vista</code> configs were created to still create APPerl for those OSes. The <code>vista</code> configs use a community fork of cosmopolitan to still provide compatibility.</p>

<p>The full potential of APPerl lies on how it's used. Building into a single portable cross-platform binary could make it ideal to include in an development SDK. <code>apperlm</code> is tailored to building custom builds of APPerl to package apps. Thus, it can allow you to create single binary releases of your Perl application. Perl is no longer a second-class citizen to languages that build to binaries, so it's more viable to use for users unable or unwilling to install Perl. Building Perl from source is not a requirement of an APPerl app, <code>nobuild</code> configs are supported allowing you to base your app off of an existing version of APPerl such as one of the official releases. APPerl can also ease the transition to newer Perl versions as deploying or switching out one binary is a lot easier than installing a whole tree of files.</p>

<h3 id="Dogfooding"><a href="https://doi.ieeecomputersociety.org/10.1109/MS.2006.72">Dogfooding</a></h3>

<p>To verify APPerl was ready for external use, it is now used for binary releases of <a href="https://metacpan.org/pod/PlayStation::MemoryCard"><code>psx_mc_cli</code></a> and <a href="https://github.com/G4Vi/MHFS#mhfs---media-http-file-server"><code>MHFS</code></a>. </p>

<p><code>psx_mc_cli</code> is a set of PlayStation MemoryCard file utilities, as expected it wasn't a very tricky port with it only having one non-core dependency, however attempting to make the smallest possible version with it's perldoc documentation required some trial and error. To ease creating minimal applications, the "-" prefix was implemented in <code>apperlm</code> to remove from the config set instead of replacing, a counter-part to the "+" prefix for appending to a config set. <a href="https://github.com/G4Vi/psx_mc_cli/blob/f2ce8c2793cdc15525f91730c0ae76260961d8f0/apperl-project.json"><code>apperl-project.json</code></a></p>

<p><code>MHFS</code> mainly required figuring out how to include the dependencies in APPerl. The <code>HTML-Template</code>, <code>URI</code>, and <code>Class-Inspector</code> distributions were able to be installed by Perl itself, by copying to the <code>cpan</code> directory. <code>File::ShareDir::Install</code> was not included as MHFS's static files could just be added to <code>zip_extra_files</code>. The <code>App-MHFS</code> distribution and <code>File::ShareDir</code> module were installed via copying from <code>zip_extra_files</code> as their <code>Makefile.PL</code>'s had extension module dependencies (<code>IO</code> and <code>Time::HiRes</code>), making them unbuildable by <code>miniperl</code>. After building, MHFS initially hung when handling some HTTP requests, however it wasn't from APPerl, but from a regression introduced attempting to clean up the socket code. Upon reverting the offending change, it worked as expected on Linux. Unfortunately, Windows compatibility isn't possible yet as Cosmopolitan doesn't support <code>fcntl</code> <code>F_SETFL</code> yet on Windows (needed to set <code>O_NONBLOCK</code> on the sockets), but I am confident it will be soon be added as cosmopolitan's Windows polyfills (for <code>fork</code>, etc) have been spectacular. <a href="https://github.com/G4Vi/MHFS/blob/c23ff7e6995f6bb47e8c56185ae7d84602c8d731/apperl/apperl-project.json"><code>apperl-project.json</code></a></p>

<h2 id="Wrap Up">Wrap Up</h2>

<p>APPerl binaries, usage information, and development links can be found on the <a href="../APPerl/">APPerl webpage</a></p>

<p>Thank you to the Cosmopolitan Libc contributors for making it possible and encouraging me along the process, especially <a href="https://justine.lol/">Justine Tunney</a> and <a href="https://ahgamut.github.io">Gautham Venkatasubramanian</a></p>


<footer>
--<br>
Gavin Hayes | gavin [at] computoid dawt com | <a href="https://github.com/G4Vi">GitHub</a> | <a href="https://metacpan.org/author/GAHAYES">CPAN</a>
<br>
</footer>
</div>
</body>
</html>